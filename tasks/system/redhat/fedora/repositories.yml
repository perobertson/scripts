---
- name: Fedora - Import Docker signing key
  rpm_key:
    state: present
    key: https://download.docker.com/linux/fedora/gpg
    fingerprint: 060A61C51B558A7F742B77AAC52FEB6B621E9F35

- name: Fedora - Import RPM-GPG-KEY-rpmfusion-free
  rpm_key:
    state: present
    key: "{{ signing_keys.rpmfusion_free_fedora[ansible_distribution_major_version].key }}"
    fingerprint: "{{ signing_keys.rpmfusion_free_fedora[ansible_distribution_major_version].fingerprint }}"

- name: Fedora - Import RPM-GPG-KEY-rpmfusion-nonfree
  rpm_key:
    state: present
    key: "{{ signing_keys.rpmfusion_nonfree_fedora[ansible_distribution_major_version].key }}"
    fingerprint: "{{ signing_keys.rpmfusion_nonfree_fedora[ansible_distribution_major_version].fingerprint }}"

- name: Fedora - Import Zoom signing key
  rpm_key:
    state: present
    key: https://zoom.us/linux/download/pubkey
    fingerprint: 396060CADD8A75220BFCB369B903BF1861A7C71D

- name: Fedora - check if rpmfusion-free.repo file exists
  stat:
    path: /etc/yum.repos.d/rpmfusion-free.repo
  register: rpmfusion_free_repo

- name: Fedora - check if rpmfusion-free-updates.repo file exists
  stat:
    path: /etc/yum.repos.d/rpmfusion-free-updates.repo
  register: rpmfusion_free_updates_repo

- name: Fedora - Add RPMFusion-free repository
  dnf:
    name:
      - https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version|int }}.noarch.rpm
    state: present
  when: (not rpmfusion_free_repo.stat.exists) or
        (not rpmfusion_free_updates_repo.stat.exists)
  register: rpmfusion_free_install
  until: rpmfusion_free_install is succeeded
  retries: 5
  delay: 5

- name: Fedora - check if rpmfusion-nonfree.repo file exists
  stat:
    path: /etc/yum.repos.d/rpmfusion-nonfree.repo
  register: rpmfusion_nonfree_repo

- name: Fedora - check if rpmfusion-nonfree-updates.repo file exists
  stat:
    path: /etc/yum.repos.d/rpmfusion-nonfree-updates.repo
  register: rpmfusion_nonfree_updates_repo

- name: Fedora - Add RPMFusion-nonfree repository
  dnf:
    name:
      - https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_major_version|int }}.noarch.rpm
    state: present
  when: (not rpmfusion_nonfree_repo.stat.exists) or
        (not rpmfusion_nonfree_updates_repo.stat.exists)
  register: rpmfusion_nonfree_install
  until: rpmfusion_nonfree_install is succeeded
  retries: 5
  delay: 5

- name: Fedora <=25 - Add MySQL community repository
  dnf:
    name:
      - "https://dev.mysql.com/get/mysql57-community-release-fc{{ ansible_distribution_major_version|int }}-10.noarch.rpm"
    state: present
  when: ansible_distribution_major_version|int <= 25

- name: Fedora 26,27 - Add MySQL community repository
  dnf:
    name:
      - "https://dev.mysql.com/get/mysql80-community-release-fc{{ ansible_distribution_major_version|int }}-1.noarch.rpm"
    state: present
  when:
    - ansible_distribution_major_version|int >= 26
    - ansible_distribution_major_version|int <= 27

- name: Fedora >=30 - Add Razer repository
  yum_repository:
    file: razer
    name: razer
    description: Razer drivers (Fedora {{ ansible_distribution_major_version|int }})
    baseurl: "https://download.opensuse.org/repositories/hardware:/razer/Fedora_{{ ansible_distribution_major_version|int }}/"
    enabled: yes
    gpgcheck: yes
    gpgkey: "https://download.opensuse.org/repositories/hardware:/razer/Fedora_{{ ansible_distribution_major_version|int }}/repodata/repomd.xml.key"
    repo_gpgcheck: yes
  when: ansible_distribution_major_version|int >= 30

# TODO: remove this once a F32 repo is available
- name: Fedora 32 - Add Docker repository for Fedora 31
  tags: [ docker ]
  yum_repository:
    file: docker-ce
    name: docker-ce-stable
    description: "Docker CE Stable - {{ ansible_distribution }} - 31 - $basearch"
    baseurl: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/31/$basearch/stable"
  when: ansible_distribution_major_version|int == 32
