.build: &build_definition
  stage: build
  tags:
    - docker
  script:
    - whoami
    - echo "$HOME"
    - pwd
    - ls -laH
    - /usr/bin/curl -sSL https://gitlab.com/perobertson/scripts/raw/${CI_COMMIT_SHA}/setup.sh | bash


lint:
  stage: build
  image: python:latest
  tags:
    - docker
  script:
    - pip install --user --upgrade bashate
    - ~/.local/bin/bashate --ignore=E006 $(find . -name '*.sh')


fedora_25:
  <<: *build_definition
  image: fedora:25
  before_script:
    - dnf install -y sudo


fedora_26:
  <<: *build_definition
  image: fedora:26
  before_script:
    - dnf install -y sudo


fedora_27:
  <<: *build_definition
  image: fedora:27
  before_script:
    - dnf install -y sudo


fedora_28:
  <<: *build_definition
  image: fedora:28
  before_script:
    - dnf install -y sudo
  allow_failure: true


fedora_rawhide:
  <<: *build_definition
  image: fedora:rawhide
  before_script:
    - dnf install -y sudo
  allow_failure: true


ubuntu_16_04:
  <<: *build_definition
  image: ubuntu:16.04
  before_script:
    - apt-get update
    - apt-get install -y sudo
  allow_failure: true


ubuntu_17_10:
  <<: *build_definition
  image: ubuntu:17.10
  before_script:
    - apt-get update
    - apt-get install -y sudo
  allow_failure: true


deploy_github:
  stage: deploy
  script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "${GITHUB_KEY}" > ~/.ssh/id_rsa
    - echo "${GITHUB_KEY_PUB}" > ~/.ssh/id_rsa.pub
    - chmod 700 ~/.ssh/id_rsa*
    - ssh-keyscan 'github.com' >> ~/.ssh/known_hosts
    - git remote add github -t master git@github.com:perobertson/scripts.git
    - git fetch --all --verbose
    - git checkout -B ${CI_COMMIT_REF_SLUG}
    - git push --set-upstream github ${CI_COMMIT_REF_SLUG}
  environment:
    name: github
  only:
    refs:
      - master
